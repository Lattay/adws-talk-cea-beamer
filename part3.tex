\begin{frame}
  \frametitle{Solution for the plane wave part of the density}
  Take advantage of the initial state of data in \texttt{mkrho}
  
  \begin{block}{Goal}
    Temporarily modify the data to make it look like normal DFT data.
  \end{block}
\end{frame}

\begin{frame}
  In practice we:
  \begin{enumerate}
    \item Compute the eigen values and eigen vectors of the occupation matrix
    \item Eigen values replace classic occupations
    \item Apply the matrix formed by the eigen vectors as a rotation matrix to
      the matrix formed by the Kohn-Sham vectors
    \item The rotated Kohn-Sham vectors are used in place of the originals
  \end{enumerate}

  Then the rest of the computation behave just like it always has.
\end{frame}

\begin{frame}
  \frametitle{Solution for the PAW part of the density}
  \begin{itemize}
    \item Band distributed everywere \Rightarrow no tricks this time
  \end{itemize}
  But:
  \begin{itemize}
    \item PAW components are really few compared to planewaves
    \item PAW density computation is rather light
  \end{itemize}
  A carefully crafted set of point-to-point MPI communications will do the job
  just well.
\end{frame}

\SetKwFor{ForEach}{for each}{do}{}
\SetKwIF{If}{ElseIf}{Else}{if}{then}{elif}{else}{}

\begin{frame}[fragile]
  The algorithm is the following:
  \begin{algorithm}[H]
    \If{the current CPU uses correlated bands}{
      \ForEach{correlated band}{
        \If{the band is available}{
          Extract the data and put it in the buffer\;
          \ForEach{remote CPU}{
            \If{it uses correlated bands}{
              \If{it needs the current band}{
                send the band\;
              }
            }
          }
        } \Else {
          \If{this CPU need this band}{
            receive the band from the CPU that own it and put it in the buffer\;
          }
        }
      }
    }
  \end{algorithm}
  It prevents deadlocks and grant that data are available when they are used.
\end{frame}

\begin{frame}
  Some precision about the actual implementations:
  \begin{itemize}
    \item MPI communications are implemented as asynchrone communications they are
      initialized and then the computation can start with already available bands
    \item Since correlated bands form a block arround the Fermi level, not all CPUs
      are concerned
    \item This part could probably be optimized further but as we will see it does not worth it

  \end{itemize}
\end{frame}
